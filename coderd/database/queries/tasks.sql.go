// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: tasks.sql

package database

import (
	"context"
	"encoding/json"
	"time"

	"github.com/google/uuid"
)

const deleteTask = `-- name: DeleteTask :one
UPDATE tasks
SET
	deleted_at = $1::timestamptz
WHERE
	id = $2::uuid
	AND deleted_at IS NULL
RETURNING id, organization_id, owner_id, name, workspace_id, template_version_id, template_parameters, prompt, created_at, deleted_at, display_name
`

type DeleteTaskParams struct {
	DeletedAt time.Time `db:"deleted_at" json:"deleted_at"`
	ID        uuid.UUID `db:"id" json:"id"`
}

func (q *Queries) DeleteTask(ctx context.Context, arg DeleteTaskParams) (TaskTable, error) {
	row := q.db.QueryRowContext(ctx, deleteTask, arg.DeletedAt, arg.ID)
	var i TaskTable
	err := row.Scan(
		&i.ID,
		&i.OrganizationID,
		&i.OwnerID,
		&i.Name,
		&i.WorkspaceID,
		&i.TemplateVersionID,
		&i.TemplateParameters,
		&i.Prompt,
		&i.CreatedAt,
		&i.DeletedAt,
		&i.DisplayName,
	)
	return i, err
}

const getTaskByID = `-- name: GetTaskByID :one
SELECT id, organization_id, owner_id, name, workspace_id, template_version_id, template_parameters, prompt, created_at, deleted_at, display_name, status, status_debug, workspace_build_number, workspace_agent_id, workspace_app_id, workspace_agent_lifecycle_state, workspace_app_health, owner_username, owner_name, owner_avatar_url FROM tasks_with_status WHERE id = $1::uuid
`

func (q *Queries) GetTaskByID(ctx context.Context, id uuid.UUID) (Task, error) {
	row := q.db.QueryRowContext(ctx, getTaskByID, id)
	var i Task
	err := row.Scan(
		&i.ID,
		&i.OrganizationID,
		&i.OwnerID,
		&i.Name,
		&i.WorkspaceID,
		&i.TemplateVersionID,
		&i.TemplateParameters,
		&i.Prompt,
		&i.CreatedAt,
		&i.DeletedAt,
		&i.DisplayName,
		&i.Status,
		&i.StatusDebug,
		&i.WorkspaceBuildNumber,
		&i.WorkspaceAgentID,
		&i.WorkspaceAppID,
		&i.WorkspaceAgentLifecycleState,
		&i.WorkspaceAppHealth,
		&i.OwnerUsername,
		&i.OwnerName,
		&i.OwnerAvatarUrl,
	)
	return i, err
}

const getTaskByOwnerIDAndName = `-- name: GetTaskByOwnerIDAndName :one
SELECT id, organization_id, owner_id, name, workspace_id, template_version_id, template_parameters, prompt, created_at, deleted_at, display_name, status, status_debug, workspace_build_number, workspace_agent_id, workspace_app_id, workspace_agent_lifecycle_state, workspace_app_health, owner_username, owner_name, owner_avatar_url FROM tasks_with_status
WHERE
	owner_id = $1::uuid
	AND deleted_at IS NULL
	AND LOWER(name) = LOWER($2::text)
`

type GetTaskByOwnerIDAndNameParams struct {
	OwnerID uuid.UUID `db:"owner_id" json:"owner_id"`
	Name    string    `db:"name" json:"name"`
}

func (q *Queries) GetTaskByOwnerIDAndName(ctx context.Context, arg GetTaskByOwnerIDAndNameParams) (Task, error) {
	row := q.db.QueryRowContext(ctx, getTaskByOwnerIDAndName, arg.OwnerID, arg.Name)
	var i Task
	err := row.Scan(
		&i.ID,
		&i.OrganizationID,
		&i.OwnerID,
		&i.Name,
		&i.WorkspaceID,
		&i.TemplateVersionID,
		&i.TemplateParameters,
		&i.Prompt,
		&i.CreatedAt,
		&i.DeletedAt,
		&i.DisplayName,
		&i.Status,
		&i.StatusDebug,
		&i.WorkspaceBuildNumber,
		&i.WorkspaceAgentID,
		&i.WorkspaceAppID,
		&i.WorkspaceAgentLifecycleState,
		&i.WorkspaceAppHealth,
		&i.OwnerUsername,
		&i.OwnerName,
		&i.OwnerAvatarUrl,
	)
	return i, err
}

const getTaskByWorkspaceID = `-- name: GetTaskByWorkspaceID :one
SELECT id, organization_id, owner_id, name, workspace_id, template_version_id, template_parameters, prompt, created_at, deleted_at, display_name, status, status_debug, workspace_build_number, workspace_agent_id, workspace_app_id, workspace_agent_lifecycle_state, workspace_app_health, owner_username, owner_name, owner_avatar_url FROM tasks_with_status WHERE workspace_id = $1::uuid
`

func (q *Queries) GetTaskByWorkspaceID(ctx context.Context, workspaceID uuid.UUID) (Task, error) {
	row := q.db.QueryRowContext(ctx, getTaskByWorkspaceID, workspaceID)
	var i Task
	err := row.Scan(
		&i.ID,
		&i.OrganizationID,
		&i.OwnerID,
		&i.Name,
		&i.WorkspaceID,
		&i.TemplateVersionID,
		&i.TemplateParameters,
		&i.Prompt,
		&i.CreatedAt,
		&i.DeletedAt,
		&i.DisplayName,
		&i.Status,
		&i.StatusDebug,
		&i.WorkspaceBuildNumber,
		&i.WorkspaceAgentID,
		&i.WorkspaceAppID,
		&i.WorkspaceAgentLifecycleState,
		&i.WorkspaceAppHealth,
		&i.OwnerUsername,
		&i.OwnerName,
		&i.OwnerAvatarUrl,
	)
	return i, err
}

const getTaskSnapshot = `-- name: GetTaskSnapshot :one
SELECT
	task_id, log_snapshot, log_snapshot_created_at
FROM
	task_snapshots
WHERE
	task_id = $1
`

func (q *Queries) GetTaskSnapshot(ctx context.Context, taskID uuid.UUID) (TaskSnapshot, error) {
	row := q.db.QueryRowContext(ctx, getTaskSnapshot, taskID)
	var i TaskSnapshot
	err := row.Scan(&i.TaskID, &i.LogSnapshot, &i.LogSnapshotCreatedAt)
	return i, err
}

const insertTask = `-- name: InsertTask :one
INSERT INTO tasks
	(id, organization_id, owner_id, name, display_name, workspace_id, template_version_id, template_parameters, prompt, created_at)
VALUES
	($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)
RETURNING id, organization_id, owner_id, name, workspace_id, template_version_id, template_parameters, prompt, created_at, deleted_at, display_name
`

type InsertTaskParams struct {
	ID                 uuid.UUID       `db:"id" json:"id"`
	OrganizationID     uuid.UUID       `db:"organization_id" json:"organization_id"`
	OwnerID            uuid.UUID       `db:"owner_id" json:"owner_id"`
	Name               string          `db:"name" json:"name"`
	DisplayName        string          `db:"display_name" json:"display_name"`
	WorkspaceID        uuid.NullUUID   `db:"workspace_id" json:"workspace_id"`
	TemplateVersionID  uuid.UUID       `db:"template_version_id" json:"template_version_id"`
	TemplateParameters json.RawMessage `db:"template_parameters" json:"template_parameters"`
	Prompt             string          `db:"prompt" json:"prompt"`
	CreatedAt          time.Time       `db:"created_at" json:"created_at"`
}

func (q *Queries) InsertTask(ctx context.Context, arg InsertTaskParams) (TaskTable, error) {
	row := q.db.QueryRowContext(ctx, insertTask,
		arg.ID,
		arg.OrganizationID,
		arg.OwnerID,
		arg.Name,
		arg.DisplayName,
		arg.WorkspaceID,
		arg.TemplateVersionID,
		arg.TemplateParameters,
		arg.Prompt,
		arg.CreatedAt,
	)
	var i TaskTable
	err := row.Scan(
		&i.ID,
		&i.OrganizationID,
		&i.OwnerID,
		&i.Name,
		&i.WorkspaceID,
		&i.TemplateVersionID,
		&i.TemplateParameters,
		&i.Prompt,
		&i.CreatedAt,
		&i.DeletedAt,
		&i.DisplayName,
	)
	return i, err
}

const listTasks = `-- name: ListTasks :many
SELECT id, organization_id, owner_id, name, workspace_id, template_version_id, template_parameters, prompt, created_at, deleted_at, display_name, status, status_debug, workspace_build_number, workspace_agent_id, workspace_app_id, workspace_agent_lifecycle_state, workspace_app_health, owner_username, owner_name, owner_avatar_url FROM tasks_with_status tws
WHERE tws.deleted_at IS NULL
AND CASE WHEN $1::UUID != '00000000-0000-0000-0000-000000000000' THEN tws.owner_id = $1::UUID ELSE TRUE END
AND CASE WHEN $2::UUID != '00000000-0000-0000-0000-000000000000' THEN tws.organization_id = $2::UUID ELSE TRUE END
AND CASE WHEN $3::text != '' THEN tws.status = $3::task_status ELSE TRUE END
ORDER BY tws.created_at DESC
`

type ListTasksParams struct {
	OwnerID        uuid.UUID `db:"owner_id" json:"owner_id"`
	OrganizationID uuid.UUID `db:"organization_id" json:"organization_id"`
	Status         string    `db:"status" json:"status"`
}

func (q *Queries) ListTasks(ctx context.Context, arg ListTasksParams) ([]Task, error) {
	rows, err := q.db.QueryContext(ctx, listTasks, arg.OwnerID, arg.OrganizationID, arg.Status)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []Task
	for rows.Next() {
		var i Task
		if err := rows.Scan(
			&i.ID,
			&i.OrganizationID,
			&i.OwnerID,
			&i.Name,
			&i.WorkspaceID,
			&i.TemplateVersionID,
			&i.TemplateParameters,
			&i.Prompt,
			&i.CreatedAt,
			&i.DeletedAt,
			&i.DisplayName,
			&i.Status,
			&i.StatusDebug,
			&i.WorkspaceBuildNumber,
			&i.WorkspaceAgentID,
			&i.WorkspaceAppID,
			&i.WorkspaceAgentLifecycleState,
			&i.WorkspaceAppHealth,
			&i.OwnerUsername,
			&i.OwnerName,
			&i.OwnerAvatarUrl,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const updateTaskPrompt = `-- name: UpdateTaskPrompt :one
UPDATE
	tasks
SET
	prompt = $1::text
WHERE
	id = $2::uuid
	AND deleted_at IS NULL
RETURNING id, organization_id, owner_id, name, workspace_id, template_version_id, template_parameters, prompt, created_at, deleted_at, display_name
`

type UpdateTaskPromptParams struct {
	Prompt string    `db:"prompt" json:"prompt"`
	ID     uuid.UUID `db:"id" json:"id"`
}

func (q *Queries) UpdateTaskPrompt(ctx context.Context, arg UpdateTaskPromptParams) (TaskTable, error) {
	row := q.db.QueryRowContext(ctx, updateTaskPrompt, arg.Prompt, arg.ID)
	var i TaskTable
	err := row.Scan(
		&i.ID,
		&i.OrganizationID,
		&i.OwnerID,
		&i.Name,
		&i.WorkspaceID,
		&i.TemplateVersionID,
		&i.TemplateParameters,
		&i.Prompt,
		&i.CreatedAt,
		&i.DeletedAt,
		&i.DisplayName,
	)
	return i, err
}

const updateTaskWorkspaceID = `-- name: UpdateTaskWorkspaceID :one
UPDATE
	tasks
SET
	workspace_id = $2
FROM
	workspaces w
JOIN
	template_versions tv
ON
	tv.template_id = w.template_id
WHERE
	tasks.id = $1
	AND tasks.workspace_id IS NULL
	AND w.id = $2
	AND tv.id = tasks.template_version_id
RETURNING
	tasks.id, tasks.organization_id, tasks.owner_id, tasks.name, tasks.workspace_id, tasks.template_version_id, tasks.template_parameters, tasks.prompt, tasks.created_at, tasks.deleted_at, tasks.display_name
`

type UpdateTaskWorkspaceIDParams struct {
	ID          uuid.UUID     `db:"id" json:"id"`
	WorkspaceID uuid.NullUUID `db:"workspace_id" json:"workspace_id"`
}

func (q *Queries) UpdateTaskWorkspaceID(ctx context.Context, arg UpdateTaskWorkspaceIDParams) (TaskTable, error) {
	row := q.db.QueryRowContext(ctx, updateTaskWorkspaceID, arg.ID, arg.WorkspaceID)
	var i TaskTable
	err := row.Scan(
		&i.ID,
		&i.OrganizationID,
		&i.OwnerID,
		&i.Name,
		&i.WorkspaceID,
		&i.TemplateVersionID,
		&i.TemplateParameters,
		&i.Prompt,
		&i.CreatedAt,
		&i.DeletedAt,
		&i.DisplayName,
	)
	return i, err
}

const upsertTaskSnapshot = `-- name: UpsertTaskSnapshot :exec
INSERT INTO
	task_snapshots (task_id, log_snapshot, log_snapshot_created_at)
VALUES
	($1, $2, $3)
ON CONFLICT
	(task_id)
DO UPDATE SET
	log_snapshot = EXCLUDED.log_snapshot,
	log_snapshot_created_at = EXCLUDED.log_snapshot_created_at
`

type UpsertTaskSnapshotParams struct {
	TaskID               uuid.UUID       `db:"task_id" json:"task_id"`
	LogSnapshot          json.RawMessage `db:"log_snapshot" json:"log_snapshot"`
	LogSnapshotCreatedAt time.Time       `db:"log_snapshot_created_at" json:"log_snapshot_created_at"`
}

func (q *Queries) UpsertTaskSnapshot(ctx context.Context, arg UpsertTaskSnapshotParams) error {
	_, err := q.db.ExecContext(ctx, upsertTaskSnapshot, arg.TaskID, arg.LogSnapshot, arg.LogSnapshotCreatedAt)
	return err
}

const upsertTaskWorkspaceApp = `-- name: UpsertTaskWorkspaceApp :one
INSERT INTO task_workspace_apps
	(task_id, workspace_build_number, workspace_agent_id, workspace_app_id)
VALUES
	($1, $2, $3, $4)
ON CONFLICT (task_id, workspace_build_number)
DO UPDATE SET
	workspace_agent_id = EXCLUDED.workspace_agent_id,
	workspace_app_id = EXCLUDED.workspace_app_id
RETURNING task_id, workspace_agent_id, workspace_app_id, workspace_build_number
`

type UpsertTaskWorkspaceAppParams struct {
	TaskID               uuid.UUID     `db:"task_id" json:"task_id"`
	WorkspaceBuildNumber int32         `db:"workspace_build_number" json:"workspace_build_number"`
	WorkspaceAgentID     uuid.NullUUID `db:"workspace_agent_id" json:"workspace_agent_id"`
	WorkspaceAppID       uuid.NullUUID `db:"workspace_app_id" json:"workspace_app_id"`
}

func (q *Queries) UpsertTaskWorkspaceApp(ctx context.Context, arg UpsertTaskWorkspaceAppParams) (TaskWorkspaceApp, error) {
	row := q.db.QueryRowContext(ctx, upsertTaskWorkspaceApp,
		arg.TaskID,
		arg.WorkspaceBuildNumber,
		arg.WorkspaceAgentID,
		arg.WorkspaceAppID,
	)
	var i TaskWorkspaceApp
	err := row.Scan(
		&i.TaskID,
		&i.WorkspaceAgentID,
		&i.WorkspaceAppID,
		&i.WorkspaceBuildNumber,
	)
	return i, err
}
