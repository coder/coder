# This goreleaser config file requires GoReleaser Pro as it uses the prebuilt
# builder type.

archives:
  - id: coder-linux
    builds: [release-prebuilt-linux]
    format: tar.gz

builds:
  - id: release-prebuilt-linux
    builder: prebuilt
    goos: [linux]
    goarch: [amd64, arm, arm64]
    goarm: ["7"]
    prebuilt:
      path: artifacts/coder-linux_{{.Os}}_{{.Arch}}{{ with .Arm }}_{{ . }}{{ end }}/coder

# This section is also contained in .goreleaser.yaml.
nfpms:
  - id: packages
    vendor: Coder
    homepage: https://coder.com
    maintainer: Coder <support@coder.com>
    description: |
      Provision development environments with infrastructure with code
    formats:
      - apk
      - deb
      - rpm
    suggests:
      - postgresql
    builds:
      - release-prebuilt-linux
    bindir: /usr/bin
    contents:
      - src: coder.env
        dst: /etc/coder.d/coder.env
        type: "config|noreplace"
      - src: coder.service
        dst: /usr/lib/systemd/system/coder.service

# Image templates are empty on snapshots to avoid lengthy builds for
# development.
dockers:
  - image_templates: ["{{ if not .IsSnapshot }}ghcr.io/coder/coder:{{ .Tag }}-amd64{{ end }}"]
    id: release-prebuilt-linux
    dockerfile: Dockerfile
    use: buildx
    build_flag_templates:
      - --platform=linux/amd64
      - --label=org.opencontainers.image.title=Coder
      - --label=org.opencontainers.image.description=A tool for provisioning self-hosted development environments with Terraform.
      - --label=org.opencontainers.image.url=https://github.com/coder/coder
      - --label=org.opencontainers.image.source=https://github.com/coder/coder
      - --label=org.opencontainers.image.version={{ .Version }}
      - --label=org.opencontainers.image.revision={{ .FullCommit }}
      - --label=org.opencontainers.image.licenses=AGPL-3.0
  - image_templates: ["{{ if not .IsSnapshot }}ghcr.io/coder/coder:{{ .Tag }}-arm64{{ end }}"]
    goarch: arm64
    dockerfile: Dockerfile
    use: buildx
    build_flag_templates:
      - --platform=linux/arm64/v8
      - --label=org.opencontainers.image.title=coder
      - --label=org.opencontainers.image.description=A tool for provisioning self-hosted development environments with Terraform.
      - --label=org.opencontainers.image.url=https://github.com/coder/coder
      - --label=org.opencontainers.image.source=https://github.com/coder/coder
      - --label=org.opencontainers.image.version={{ .Tag }}
      - --label=org.opencontainers.image.revision={{ .FullCommit }}
      - --label=org.opencontainers.image.licenses=AGPL-3.0
  - image_templates: ["{{ if not .IsSnapshot }}ghcr.io/coder/coder:{{ .Tag }}-armv7{{ end }}"]
    goarch: arm
    goarm: "7"
    dockerfile: Dockerfile
    use: buildx
    build_flag_templates:
      - --platform=linux/arm/v7
      - --label=org.opencontainers.image.title=Coder
      - --label=org.opencontainers.image.description=A tool for provisioning self-hosted development environments with Terraform.
      - --label=org.opencontainers.image.url=https://github.com/coder/coder
      - --label=org.opencontainers.image.source=https://github.com/coder/coder
      - --label=org.opencontainers.image.version={{ .Tag }}
      - --label=org.opencontainers.image.revision={{ .FullCommit }}
      - --label=org.opencontainers.image.licenses=AGPL-3.0

docker_manifests:
  - name_template: ghcr.io/coder/coder:{{ .Tag }}
    image_templates:
      - ghcr.io/coder/coder:{{ .Tag }}-amd64
      - ghcr.io/coder/coder:{{ .Tag }}-arm64
      - ghcr.io/coder/coder:{{ .Tag }}-armv7

release:
  ids: [release-prebuilt-linux, packages]
  footer: |
    ## Container Image
    - `docker pull ghcr.io/coder/coder:{{ .Tag }}`
  # All non-Linux files should just be used as is. We have to import the Linux
  # builds so that the docker images get built and package creation works.
  extra_files:
    - glob: ./artifacts/coder_*_darwin*
    - glob: ./artifacts/coder_*_windows*

snapshot:
  name_template: "{{ .Version }}-devel+{{ .ShortCommit }}"
