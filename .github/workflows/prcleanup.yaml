# .github/workflows/pr-cleanup.yml
name: PRCleanup
on:
  pull_request:
    types: [closed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number"
        required: true

env:
  PR_NUMBER: if(${{ github.event_name == 'workflow_dispatch' }}, ${{ github.event.inputs.pr_number }}, ${{ github.event.pull_request.number }})

permissions:
  packages: write

jobs:
  pr-close:
    runs-on: "ubuntu-latest"
    steps:
      - name: Delete base image
        uses: bots-house/ghcr-delete-image-action@v1.1.0
        with:
          owner: coder
          name: coder-preview-base
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: pr${{ env.PR_NUMBER }}

      - name: Delete image
        uses: bots-house/ghcr-delete-image-action@v1.1.0
        with:
          owner: coder
          name: coder-preview
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: pr${{ env.PR_NUMBER }}

          - name: "Remove PR namespace"
          run: |
            kubectl delete namespace "pr${{ env.PR_NUMBER }}" --kubeconfig "${{ secrets.DELIVERYBOT_KUBECONFIG }}"
