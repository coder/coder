# WIP: This workflow assists in evaluating the severity of incoming issues to help
# with triaging tickets. It uses AI analysis to classify issues into severity levels
# (s0-s4) when the 'triage-check' label is applied.

name: Classify Issue Severity

on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: read
  id-token: write

jobs:
  classify:
    if: github.event.label.name == 'triage-check'
    runs-on: ubuntu-latest

    steps:
      - uses: anthropics/claude-code-action@f0c8eb29807907de7f5412d04afceb5e24817127 # v1.0.23
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            REPOSITORY: ${{ github.repository }}
            ISSUE NUMBER: ${{ github.event.issue.number }}
            ISSUE TITLE: ${{ github.event.issue.title }}
            ISSUE BODY:
            ${{ github.event.issue.body }}
            AUTHOR: ${{ github.event.issue.user.login }}

            ---

            You are an expert software engineer triaging customer-reported issues for Coder, a cloud development environment platform.

            Your task is to carefully analyze the issue above and classify it into one of the following severity levels. **This requires deep reasoning and thoughtful analysis** - not just keyword matching.

            ## Severity Level Definitions

            - **s0**: Entire product and/or major feature (Tasks, Bridge, Boundaries, etc.) is broken in a way that makes it unusable for majority to all customers

            - **s1**: Core feature is broken without a workaround for limited number of customers

            - **s2**: Broken use cases or features with a workaround

            - **s3**: Issues that impair usability, cause incorrect behavior in non-critical areas, or degrade the experience, but do not block core workflows

            - **s4**: Bugs that confuse or annoy or are purely cosmetic, e.g. we don't plan on addressing them

            ## Analysis Framework

            Customers often overstate the severity of issues. You need to read between the lines and assess the **actual impact** by reasoning through:

            1. **What is actually broken?**
               - Distinguish between what the customer *says* is broken vs. what is *actually* broken
               - Is this a complete failure or a partial degradation?
               - Does the error message or symptom indicate a critical vs. minor issue?

            2. **How many users are affected?**
               - Is this affecting all customers, many customers, or a specific edge case?
               - Does the issue description suggest widespread impact or isolated incident?
               - Are there environmental factors that limit the scope?

            3. **Are there workarounds?**
               - Can users accomplish their goal through an alternative path?
               - Is there a manual process or configuration change that resolves it?
               - Even if not mentioned, do you suspect a workaround exists?

            4. **Does it block critical workflows?**
               - Can users still perform their core job functions?
               - Is this interrupting active development work or just an inconvenience?
               - What is the business impact if this remains unresolved?

            5. **What is the realistic urgency?**
               - Does this need immediate attention or can it wait?
               - Is this a regression or long-standing issue?
               - What's the actual business risk?

            ## Your Task

            1. **Think deeply** about this issue using the framework above
            2. **Reason through** each of the 5 analysis points
            3. **Compare** the issue against all 5 severity levels (s0-s4)
            4. **Determine** which severity level best matches the actual impact
            5. **Post a comment** on the issue with your assessment

            ## Insufficient Information Fail-Safe

            **It is completely acceptable to not classify an issue if you lack sufficient information.**

            If the issue description is too vague, missing critical details, or doesn't provide enough context to make a confident assessment, DO NOT force a classification. Instead, acknowledge this and explain what additional information is needed.

            Common scenarios where you should decline to classify:
            - Issue has no description or minimal details
            - Unclear what feature/component is affected
            - No reproduction steps or error messages provided
            - Ambiguous whether it's a bug, feature request, or question
            - Missing information about user impact or frequency

            ## Posting Your Assessment

            Use the GitHub CLI to post your comment. Choose ONE of the two formats below:

            ### Format 1: Confident Classification

            If you have enough information to confidently classify:

            ```bash
            gh issue comment ${{ github.event.issue.number }} --body "## ðŸ¤– Automated Severity Classification

            **Recommended Severity:** \`[S0/S1/S2/S3/S4]\`

            **Analysis:**
            [2-3 sentences explaining your reasoning - focus on the actual impact, not just symptoms. Explain why you chose this severity level over others.]

            ---
            *This classification was performed by AI analysis. Please review and adjust if needed.*"
            ```

            ### Format 2: Insufficient Information

            If you lack sufficient information to classify:

            ```bash
            gh issue comment ${{ github.event.issue.number }} --body "## ðŸ¤– Automated Severity Classification

            **Status:** Unable to classify - insufficient information

            **Reasoning:**
            [2-3 sentences explaining what critical information is missing and why it's needed to determine severity. Be specific about what additional details would help.]

            **Suggested next steps:**
            [Bullet list of specific information the reporter should provide]

            ---
            *This classification was performed by AI analysis. Please provide the requested information for proper severity assessment.*"
            ```

            **Important**:
            - Replace `[S0/S1/S2/S3/S4]` with your chosen severity (use uppercase) - only if using Format 1
            - Replace placeholders with your actual reasoning
            - Be specific and cite details from the issue that informed your decision
            - Show your work - explain why this is s2 and not s1 or s3, for example
            - **Be honest** - it's better to request more info than to misclassify

          claude_args: |
            --allowedTools "Bash(gh issue:*)"
