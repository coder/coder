name: Docs Preview
on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'docs/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  preview:
    name: Generate docs preview
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@4d991eb9b905ef189e4c376166672c3f2f230481 # v2.11.0
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@2a398787e7b39c6ca11ce0843e5956d0b4165c80 # v43.0.0
        with:
          files: |
            docs/**

      - name: Check if manifest changed
        id: manifest-check
        run: |
          echo "changed=${{ contains(steps.changed-files.outputs.all_changed_files, 'docs/manifest.json') }}" >> $GITHUB_OUTPUT

      - name: Generate docs preview
        id: docs-preview
        uses: ./.github/actions/docs-preview
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          changed-files: ${{ steps.changed-files.outputs.all_changed_files_json }}
          manifest-changed: ${{ steps.manifest-check.outputs.changed }}

      - name: Find existing comment
        if: steps.docs-preview.outputs.has_changes == 'true'
        uses: peter-evans/find-comment@3eae4d37986fb5a8592848f6a574fdf654e61f9e # v3.1.0
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '## ðŸ“š Docs Preview'

      - name: Create or update preview comment
        if: steps.docs-preview.outputs.has_changes == 'true'
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ðŸ“š Docs Preview

            Your documentation changes are available for preview at:
            **ðŸ”— [Vercel Preview](${{ steps.docs-preview.outputs.url }})**

            ### Changed Documentation Files
            ${{ steps.docs-preview.outputs.changed_files }}

            ${{ steps.docs-preview.outputs.has_new_docs == 'true' && '### Newly Added Documentation' || '' }}
            ${{ steps.docs-preview.outputs.has_new_docs == 'true' && steps.docs-preview.outputs.new_docs || '' }}

            ${{ steps.docs-preview.outputs.has_new_docs == 'true' && '### Preview Links for New Docs' || '' }}
            ${{ steps.docs-preview.outputs.has_new_docs == 'true' && steps.docs-preview.outputs.preview_links || '' }}

            ---
            <sub>ðŸ¤– This comment is automatically generated and updated when documentation changes.</sub>
          edit-mode: replace
          reactions: eyes