name: 'Docs Shared Action'
description: 'A composite action providing shared functionality for docs-related workflows'
author: 'Coder'

inputs:
  github-token:
    description: 'GitHub token for API operations'
    required: true
  docs-dir:
    description: 'Path to the docs directory'
    required: false
    default: 'docs'
  include-md-files:
    description: 'Whether to include all markdown files (not just in docs dir)'
    required: false
    default: 'false'
  check-links:
    description: 'Whether to check links in markdown files'
    required: false
    default: 'false'
  lint-markdown:
    description: 'Whether to lint markdown files'
    required: false
    default: 'false'
  check-format:
    description: 'Whether to check (but not format) markdown table formatting'
    required: false
    default: 'false'
  lint-vale:
    description: 'Whether to run Vale style checks on documentation'
    required: false
    default: 'true'
  check-cross-references:
    description: 'Whether to check for broken cross-references when files or headings change'
    required: false
    default: 'true'
  generate-preview:
    description: 'Whether to generate preview links'
    required: false
    default: 'false'
  post-comment:
    description: 'Whether to post a PR comment with results'
    required: false
    default: 'false'
  pr-number:
    description: 'PR number for commenting (required if post-comment is true)'
    required: false
    default: ''
  fail-on-error:
    description: 'Whether to fail the workflow on errors'
    required: false
    default: 'true'

outputs:
  has_changes:
    description: 'Boolean indicating if documentation files have changed'
    value: ${{ steps.docs-analysis.outputs.has_changes }}
  changed_files:
    description: 'JSON array of changed documentation files'
    value: ${{ steps.changed-files.outputs.all_changed_files_json }}
  formatted_changed_files:
    description: 'Markdown-formatted list of changed files with links'
    value: ${{ steps.docs-analysis.outputs.formatted_files || '' }}
  preview_url:
    description: 'Documentation preview URL'
    value: ${{ steps.generate-preview.outputs.url || '' }}
  manifest_changed:
    description: 'Boolean indicating if manifest.json changed'
    value: ${{ steps.manifest-check.outputs.changed || 'false' }}
  has_new_docs:
    description: 'Boolean indicating if new docs were added in manifest.json'
    value: ${{ steps.docs-analysis.outputs.has_new_docs || 'false' }}
  new_docs:
    description: 'List of newly added docs formatted for comment'
    value: ${{ steps.docs-analysis.outputs.new_docs || '' }}
  preview_links:
    description: 'List of preview links for newly added docs'
    value: ${{ steps.docs-analysis.outputs.preview_links || '' }}
  lint_results:
    description: 'Results from linting'
    value: ${{ steps.lint-docs.outputs.result || '' }}
  format_results:
    description: 'Results from format checking'
    value: ${{ steps.format-docs.outputs.result || '' }}
  link_check_results:
    description: 'Results from link checking'
    value: ${{ steps.check-links.outputs.result || '' }}
  vale_results:
    description: 'Results from Vale style checks'
    value: ${{ steps.lint-vale.outputs.result || '' }}
  cross_ref_results:
    description: 'Results from cross-reference checking'
    value: ${{ steps.cross-references.outputs.cross_ref_results || '' }}

runs:
  using: 'composite'
  steps:
    - name: Set security environment
      shell: bash
      run: |
        # Secure the environment by clearing potentially harmful variables
        unset HISTFILE
        umask 077
        
        # Validate that docs directory exists
        if [ ! -d "${{ inputs.docs-dir }}" ]; then
          echo "::error::Docs directory '${{ inputs.docs-dir }}' does not exist"
          exit 1
        fi

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@27ae6b33eaed7bf87272fdeb9f1c54f9facc9d99 # v45.0.7
      with:
        files: |
          ${{ inputs.docs-dir }}/**
          ${{ inputs.include-md-files == 'true' && '**.md' || '' }}
        separator: ','
        json: true
        
    - name: Process file lists
      id: process-files
      shell: bash
      run: |
        # Set up environment
        CHANGED_FILES='${{ steps.changed-files.outputs.all_changed_files_json }}'
        DELETED_FILES='${{ steps.changed-files.outputs.deleted_files_json || '[]' }}'
        
        # Process files into different formats once
        echo "md_files_comma<<EOF" >> $GITHUB_OUTPUT
        echo "${{ steps.changed-files.outputs.all_changed_files }}" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "md_files_line<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_FILES" | jq -r '.[] | select(endswith(".md"))' >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "docs_files_line<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_FILES" | jq -r '.[] | select(endswith(".md")) | select(startswith("${{ inputs.docs-dir }}/"))' >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "deleted_md_files_line<<EOF" >> $GITHUB_OUTPUT
        echo "$DELETED_FILES" | jq -r '.[] | select(endswith(".md"))' >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Check if manifest changed
      id: manifest-check
      shell: bash
      run: |
        if [[ "${{ steps.changed-files.outputs.all_changed_files }}" == *"${{ inputs.docs-dir }}/manifest.json"* ]]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Analyze docs changes
      id: docs-analysis
      shell: bash
      run: |
        # Set up environment
        CHANGED_FILES='${{ steps.changed-files.outputs.all_changed_files_json }}'
        
        # Make sure we have valid JSON
        if [ -z "$CHANGED_FILES" ] || [ "$CHANGED_FILES" == "[]" ]; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "formatted_files=" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Count total changed doc files
        DOC_FILES_COUNT=$(echo $CHANGED_FILES | jq -r 'length')
        echo "doc_files_count=$DOC_FILES_COUNT" >> $GITHUB_OUTPUT
        
        # Determine if docs have changed
        if [ "$DOC_FILES_COUNT" -gt 0 ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "formatted_files=" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Only continue formatting if we need to generate previews or post comments
        if [ "${{ inputs.generate-preview }}" != "true" ] && [ "${{ inputs.post-comment }}" != "true" ]; then
          exit 0
        fi
        
        # Get branch name for URLs
        BRANCH_NAME=$(jq --raw-output .pull_request.head.ref "$GITHUB_EVENT_PATH" || echo "main")
        
        # Format changed files for comment with clickable links
        FORMATTED_FILES=""
        echo $CHANGED_FILES | jq -c '.[]' | while read -r file_path; do
          # Remove quotes
          file_path=$(echo $file_path | tr -d '"')
          [ -z "$file_path" ] && continue
          
          # Only process docs files
          if [[ $file_path == ${{ inputs.docs-dir }}/* ]]; then
            # Create direct link to file
            # Remove .md extension and docs/ prefix for the URL path
            url_path=$(echo "$file_path" | sed 's/^${{ inputs.docs-dir }}\///' | sed 's/\.md$//')
            file_url="https://coder.com/docs/@${BRANCH_NAME}/${url_path}"
            
            # Add the formatted line with link
            FORMATTED_FILES="${FORMATTED_FILES}- [$file_path]($file_url)\n"
          fi
        done
        
        echo "formatted_files<<EOF" >> $GITHUB_OUTPUT
        echo -e "$FORMATTED_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # Analyze manifest changes if needed
        if [ "${{ steps.manifest-check.outputs.changed }}" == "true" ]; then
          # Get the base SHA for diff
          BASE_SHA=$(git merge-base HEAD origin/main)
          
          # Extract new docs from manifest.json diff with safe patterns
          NEW_DOCS=$(git diff "$BASE_SHA"..HEAD -- "${{ inputs.docs-dir }}/manifest.json" | grep -E '^\+.*"path":' | sed -E 's/.*"path": *"(.*)".*/\1/g')
          
          if [ -n "$NEW_DOCS" ]; then
            echo "has_new_docs=true" >> $GITHUB_OUTPUT
            
            # Format new docs for comment
            FORMATTED_NEW_DOCS=$(echo "$NEW_DOCS" | sort | uniq | grep -v "^$" | sed 's/^/- `/g' | sed 's/$/`/g')
            echo "new_docs<<EOF" >> $GITHUB_OUTPUT
            echo "$FORMATTED_NEW_DOCS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            # Generate preview links for new docs
            PREVIEW_LINKS=""
            while IFS= read -r doc_path; do
              # Skip empty lines
              [ -z "$doc_path" ] && continue
              
              # Clean the path and sanitize
              clean_path=${doc_path#./}
              clean_path=$(echo "$clean_path" | tr -cd 'a-zA-Z0-9_./-')
              
              # Generate preview URL with correct format
              url_path=$(echo "$clean_path" | sed 's/\.md$//')
              preview_url="https://coder.com/docs/@${BRANCH_NAME}/${url_path}"
              
              # Extract doc title or use filename safely
              if [ -f "$doc_path" ]; then
                title=$(grep -m 1 "^# " "$doc_path" | sed 's/^# //')
                title=$(echo "$title" | tr -cd 'a-zA-Z0-9 _.,-')
                [ -z "$title" ] && title=$(basename "$doc_path" .md | tr -cd 'a-zA-Z0-9_.-')
              else
                title=$(basename "$doc_path" .md | tr -cd 'a-zA-Z0-9_.-')
              fi
              
              PREVIEW_LINKS="${PREVIEW_LINKS}- [$title]($preview_url)\n"
            done <<< "$NEW_DOCS"
            
            echo "preview_links<<EOF" >> $GITHUB_OUTPUT
            echo -e "$PREVIEW_LINKS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_new_docs=false" >> $GITHUB_OUTPUT
          fi
        fi

    - name: Setup Node
      if: inputs.lint-markdown == 'true' || inputs.format-markdown == 'true'
      uses: ./.github/actions/setup-node

    - name: Lint Markdown
      if: inputs.lint-markdown == 'true' && steps.docs-analysis.outputs.has_changes == 'true'
      id: lint-docs
      shell: bash
      run: |
        lint_output=$(pnpm exec markdownlint-cli2 ${{ steps.process-files.outputs.md_files_comma }} 2>&1) || true
        echo "result<<EOF" >> $GITHUB_OUTPUT
        echo "$lint_output" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        if [ -n "$lint_output" ] && [ "${{ inputs.fail-on-error }}" == "true" ]; then
          echo "::error::Markdown linting found issues:"
          echo "$lint_output"
          exit 1
        fi

    - name: Check Markdown Table Formatting
      if: inputs.check-format == 'true' && steps.docs-analysis.outputs.has_changes == 'true'
      id: format-docs
      shell: bash
      run: |
        # markdown-table-formatter requires a space separated list of files
        format_output=$(echo "${{ steps.process-files.outputs.md_files_line }}" | pnpm exec markdown-table-formatter --check 2>&1) || true
        echo "result<<EOF" >> $GITHUB_OUTPUT
        echo "$format_output" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        if [ -n "$format_output" ] && [ "${{ inputs.fail-on-error }}" == "true" ]; then
          echo "::error::Markdown table formatting issues found. Run 'make fmt/markdown' locally to fix them."
          echo "$format_output"
          exit 1
        fi

    - name: Check Markdown links
      if: inputs.check-links == 'true' && steps.docs-analysis.outputs.has_changes == 'true'
      id: check-links
      uses: umbrelladocs/action-linkspector@49cf4f8da82db70e691bb8284053add5028fa244 # v1.3.2
      with:
        reporter: github-pr-review
        config_file: ".github/docs/.linkspector.yml"
        fail_on_error: ${{ inputs.fail-on-error }}
        filter_mode: "nofilter"
        
    - name: Install Vale
      if: inputs.lint-vale == 'true' && steps.docs-analysis.outputs.has_changes == 'true'
      uses: errata-ai/vale-action@v2
      with:
        config: .github/docs/vale/.vale.ini
      
    - name: Run Vale style checks
      if: inputs.lint-vale == 'true' && steps.docs-analysis.outputs.has_changes == 'true'
      id: lint-vale
      shell: bash
      run: |
        # Run Vale on changed files and capture output
        vale_output=$(echo "${{ steps.process-files.outputs.md_files_line }}" | xargs -r vale --config=.github/docs/vale/.vale.ini --output=line 2>&1) || true
        
        echo "result<<EOF" >> $GITHUB_OUTPUT
        echo "$vale_output" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        if [ -n "$vale_output" ] && [ "${{ inputs.fail-on-error }}" == "true" ]; then
          echo "::error::Vale style check found issues:"
          echo "$vale_output"
          exit 1
        fi
        
    - name: Check for broken cross-references
      if: inputs.check-cross-references == 'true' && steps.docs-analysis.outputs.has_changes == 'true'
      id: cross-references
      shell: bash
      run: |
        # Get the base branch (usually main)
        BASE_SHA=$(git merge-base HEAD origin/main)
        
        echo "Checking for broken cross-references..."
        
        # Initialize results
        BROKEN_REFS=""
        
        # Process deleted files
        if [ -n "${{ steps.process-files.outputs.deleted_md_files_line }}" ]; then
          echo "Processing deleted files"
          
          # Loop through deleted markdown files
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            echo "File $file was deleted, checking for references..."
            
            # Convert file path to potential link formats (removing .md extension)
            OLD_PATH=$(echo "$file" | sed 's/\.md$//')
            
            # Search in docs directory
            DOC_REFS=$(grep -r --include="*.md" -l -E "\[$OLD_PATH\]|\($OLD_PATH\)" ${{ inputs.docs-dir }} || echo "")
            
            # Search in codebase (excluding specific directories)
            CODE_REFS=$(grep -r --include="*.{go,ts,js,py,java,cs,php}" -l "$OLD_PATH" . --exclude-dir={node_modules,.git,build,dist} || echo "")
            
            if [ -n "$DOC_REFS" ] || [ -n "$CODE_REFS" ]; then
              BROKEN_REFS="${BROKEN_REFS}## References to deleted file: $file\n\n"
              
              if [ -n "$DOC_REFS" ]; then
                BROKEN_REFS="${BROKEN_REFS}### In documentation:\n"
                BROKEN_REFS="${BROKEN_REFS}$(echo "$DOC_REFS" | sed 's/^/- /')\n\n"
              fi
              
              if [ -n "$CODE_REFS" ]; then
                BROKEN_REFS="${BROKEN_REFS}### In codebase:\n"
                BROKEN_REFS="${BROKEN_REFS}$(echo "$CODE_REFS" | sed 's/^/- /')\n\n"
              fi
            fi
          done <<< "${{ steps.process-files.outputs.deleted_md_files_line }}"
        fi
        
        # Process modified files for heading changes
        while IFS= read -r file; do
          [ -z "$file" ] && continue
          
          if [ -f "$file" ]; then
            echo "Checking for changed headings in $file..."
            
            # Extract headings before the change
            OLD_HEADINGS=$(git show "$BASE_SHA:$file" 2>/dev/null | grep -E "^#{1,6} " | sed 's/^#\{1,6\} \(.*\)$/\1/' || echo "")
            
            # Extract current headings
            NEW_HEADINGS=$(cat "$file" | grep -E "^#{1,6} " | sed 's/^#\{1,6\} \(.*\)$/\1/')
            
            # Find removed headings
            REMOVED_HEADINGS=$(comm -23 <(echo "$OLD_HEADINGS" | sort) <(echo "$NEW_HEADINGS" | sort))
            
            if [ -n "$REMOVED_HEADINGS" ]; then
              while IFS= read -r heading; do
                [ -z "$heading" ] && continue
                
                # Convert heading to anchor format (lowercase, spaces to hyphens)
                ANCHOR=$(echo "$heading" | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:] -' | tr ' ' '-')
                
                # Search for references to this anchor in documentation
                HEAD_REFS=$(grep -r --include="*.md" -l "#$ANCHOR" ${{ inputs.docs-dir }} || echo "")
                
                if [ -n "$HEAD_REFS" ]; then
                  BROKEN_REFS="${BROKEN_REFS}## References to removed heading: '$heading' in $file\n\n"
                  BROKEN_REFS="${BROKEN_REFS}$(echo "$HEAD_REFS" | sed 's/^/- /')\n\n"
                fi
              done <<< "$REMOVED_HEADINGS"
            fi
          fi
        done <<< "${{ steps.process-files.outputs.docs_files_line }}"
        
        # Check for renamed files by comparing paths
        while IFS= read -r file; do
          [ -z "$file" ] && continue
          
          # Use git to check if this is a renamed file
          PREV_PATH=$(git diff --name-status "$BASE_SHA" | grep "^R" | grep "$file$" | cut -f2)
          
          if [ -n "$PREV_PATH" ] && [ "$PREV_PATH" != "$file" ]; then
            echo "File renamed from $PREV_PATH to $file, checking for references..."
            
            # Convert old file path to potential link formats
            OLD_PATH=$(echo "$PREV_PATH" | sed 's/\.md$//')
            
            # Search in docs directory
            DOC_REFS=$(grep -r --include="*.md" -l -E "\[$OLD_PATH\]|\($OLD_PATH\)" ${{ inputs.docs-dir }} || echo "")
            
            # Search in codebase (excluding specific directories)
            CODE_REFS=$(grep -r --include="*.{go,ts,js,py,java,cs,php}" -l "$OLD_PATH" . --exclude-dir={node_modules,.git,build,dist} || echo "")
            
            if [ -n "$DOC_REFS" ] || [ -n "$CODE_REFS" ]; then
              BROKEN_REFS="${BROKEN_REFS}## References to renamed file: $PREV_PATH → $file\n\n"
              
              if [ -n "$DOC_REFS" ]; then
                BROKEN_REFS="${BROKEN_REFS}### In documentation:\n"
                BROKEN_REFS="${BROKEN_REFS}$(echo "$DOC_REFS" | sed 's/^/- /')\n\n"
              fi
              
              if [ -n "$CODE_REFS" ]; then
                BROKEN_REFS="${BROKEN_REFS}### In codebase:\n"
                BROKEN_REFS="${BROKEN_REFS}$(echo "$CODE_REFS" | sed 's/^/- /')\n\n"
              fi
            fi
          fi
        done <<< "${{ steps.process-files.outputs.md_files_line }}"
        
        if [ -n "$BROKEN_REFS" ]; then
          echo "cross_ref_results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$BROKEN_REFS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          if [ "${{ inputs.fail-on-error }}" == "true" ]; then
            echo "::error::Broken cross-references found. See output for details."
            exit 1
          fi
        else
          echo "No broken cross-references found"
        fi

    - name: Generate Preview URL
      if: inputs.generate-preview == 'true' && steps.docs-analysis.outputs.has_changes == 'true'
      id: generate-preview
      shell: bash
      run: |
        # Get PR branch name for URL
        BRANCH_NAME=$(jq --raw-output .pull_request.head.ref "$GITHUB_EVENT_PATH")
        
        # Input validation - ensure branch name is valid
        if [ -z "$BRANCH_NAME" ]; then
          echo "::warning::Could not determine branch name, using 'main'"
          BRANCH_NAME="main"
        fi
        
        # Create the correct preview URL
        PREVIEW_URL="https://coder.com/docs/@$BRANCH_NAME"
        echo "url=$PREVIEW_URL" >> $GITHUB_OUTPUT

    - name: Find existing comment
      if: inputs.post-comment == 'true' && steps.docs-analysis.outputs.has_changes == 'true' && inputs.pr-number != ''
      id: find-comment
      uses: peter-evans/find-comment@3eae4d37986fb5a8592848f6a574fdf654e61f9e # v3.1.0
      with:
        issue-number: ${{ inputs.pr-number }}
        comment-author: 'github-actions[bot]'
        body-includes: '## 📚 Docs Preview'
        direction: last

    - name: Create or update preview comment
      if: inputs.post-comment == 'true' && steps.docs-analysis.outputs.has_changes == 'true' && inputs.pr-number != ''
      uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      with:
        comment-id: ${{ steps.find-comment.outputs.comment-id }}
        issue-number: ${{ inputs.pr-number }}
        body: |
          # 📚 Documentation Check Results

          ## 🔎 Status Overview

          ${{ steps.lint-docs.outputs.result == '' && '✅ **Markdown Linting**: No issues found' || '❌ **Markdown Linting**: Issues found' }}
          ${{ steps.format-docs.outputs.result == '' && '✅ **Table Formatting**: No issues found' || '❌ **Table Formatting**: Issues found' }}
          ${{ steps.lint-vale.outputs.result == '' && '✅ **Vale Style**: No issues found' || '❌ **Vale Style**: Issues found' }}
          ${{ steps.cross-references.outputs.cross_ref_results == '' && '✅ **Cross-References**: No broken references' || '❌ **Cross-References**: Broken references found' }}
          ${{ steps.check-links.outputs.result == '' && '✅ **Links**: All links are valid' || '⚠️ **Links**: Issues found' }}

          ## 🖥️ Preview Your Changes

          ${{ steps.generate-preview.outputs.url != '' && '**🔗 [View Documentation Preview](' || '' }}${{ steps.generate-preview.outputs.url }}${{ steps.generate-preview.outputs.url != '' && ')**' || 'No preview available' }}

          <details>
          <summary><strong>📄 Changed Documentation Files</strong></summary>

          ${{ steps.docs-analysis.outputs.formatted_files || 'No documentation files changed' }}
          </details>

          ${{ steps.docs-analysis.outputs.has_new_docs == 'true' && '<details>' || '' }}
          ${{ steps.docs-analysis.outputs.has_new_docs == 'true' && '<summary><strong>🆕 Newly Added Documentation</strong></summary>' || '' }}
          ${{ steps.docs-analysis.outputs.has_new_docs == 'true' && steps.docs-analysis.outputs.new_docs || '' }}

          ${{ steps.docs-analysis.outputs.has_new_docs == 'true' && '### Preview Links' || '' }}
          ${{ steps.docs-analysis.outputs.has_new_docs == 'true' && steps.docs-analysis.outputs.preview_links || '' }}
          ${{ steps.docs-analysis.outputs.has_new_docs == 'true' && '</details>' || '' }}

          ${{ steps.lint-docs.outputs.result != '' && '<details>' || '' }}
          ${{ steps.lint-docs.outputs.result != '' && '<summary><strong>⚠️ Markdown Linting Issues</strong></summary>' || '' }}
          ${{ steps.lint-docs.outputs.result != '' && '
          ### How to Fix
          
          Run these commands locally to fix or see detailed issues:
          ```bash
          # To view issues
          npm run lint-docs
          
          # Many issues can be fixed automatically with
          npm run lint-docs -- --fix
          ```
          
          ### Issue Details
          ```
          ' || '' }}
          ${{ steps.lint-docs.outputs.result != '' && steps.lint-docs.outputs.result || '' }}
          ${{ steps.lint-docs.outputs.result != '' && '```
          </details>' || '' }}

          ${{ steps.format-docs.outputs.result != '' && '<details>' || '' }}
          ${{ steps.format-docs.outputs.result != '' && '<summary><strong>📏 Markdown Table Formatting Issues</strong></summary>' || '' }}
          ${{ steps.format-docs.outputs.result != '' && '
          ### How to Fix
          
          Run this command locally to automatically fix all table formatting issues:
          ```bash
          make fmt/markdown
          ```
          
          ### Issue Details
          ```
          ' || '' }}
          ${{ steps.format-docs.outputs.result != '' && steps.format-docs.outputs.result || '' }}
          ${{ steps.format-docs.outputs.result != '' && '```
          </details>' || '' }}

          ${{ steps.lint-vale.outputs.result != '' && '<details>' || '' }}
          ${{ steps.lint-vale.outputs.result != '' && '<summary><strong>📝 Vale Style Issues</strong></summary>' || '' }}
          ${{ steps.lint-vale.outputs.result != '' && '
          ### How to Fix
          
          These style issues help maintain consistent documentation quality. Most Vale suggestions improve:
          
          - Readability (sentence length, passive voice)
          - Consistency (terminology, capitalization)
          - Clarity (avoiding jargon, ambiguous wording)
          - Inclusivity (avoiding gendered or ableist language)
          
          ### Issue Details
          ```
          ' || '' }}
          ${{ steps.lint-vale.outputs.result != '' && steps.lint-vale.outputs.result || '' }}
          ${{ steps.lint-vale.outputs.result != '' && '```
          </details>' || '' }}

          ${{ steps.cross-references.outputs.cross_ref_results != '' && '<details>' || '' }}
          ${{ steps.cross-references.outputs.cross_ref_results != '' && '<summary><strong>🔗 Broken Cross-References</strong></summary>' || '' }}
          ${{ steps.cross-references.outputs.cross_ref_results != '' && '
          ### How to Fix
          
          The following changes in your PR may have broken existing references:
          
          - For **deleted files**: Update or remove references to these files
          - For **renamed files**: Update links to use the new file path
          - For **removed headings**: Update or remove references to these headings
          
          ### Detected Issues
          ' || '' }}
          ${{ steps.cross-references.outputs.cross_ref_results != '' && steps.cross-references.outputs.cross_ref_results || '' }}
          ${{ steps.cross-references.outputs.cross_ref_results != '' && '</details>' || '' }}

          ---
          <sub>🤖 This comment is automatically generated and updated when documentation changes. [View Workflow](https://github.com/coder/coder/blob/main/.github/docs/README.md)</sub>
        edit-mode: replace
        reactions: eyes
        reactions-edit-mode: replace