name: 'Multi-arch Docker Image Attestation'
description: 'Create GitHub attestation for a multi-arch Docker image'

inputs:
  image-name:
    description: 'Full image name including registry and tag (e.g., ghcr.io/coder/coder-preview:main)'
    required: true
  workflow:
    description: 'Name of the GitHub workflow'
    required: true
  workflow-ref:
    description: 'Git ref that triggered the workflow'
    required: true
  workflow-sha:
    description: 'Git SHA of the workflow run'
    required: true
  workflow-run-id:
    description: 'GitHub Actions run ID'
    required: true
  repository:
    description: 'GitHub repository name (e.g., owner/repo)'
    required: true
  push-to-registry:
    description: 'Whether to push the attestation to the registry'
    required: false
    default: 'true'

runs:
  using: "composite"
  steps:
    - name: Get manifest digest
      id: get_digest
      shell: bash
      run: |
        set -euo pipefail
        
        # Get the manifest list digest for our multi-arch image
        # We use --raw to get the full manifest and extract the digest
        manifests=$(docker buildx imagetools inspect --raw ${{ inputs.image-name }})
        
        # Extract the manifest list digest which represents all architectures
        DIGEST=$(echo "$manifests" | sha256sum | cut -d' ' -f1)
        DIGEST="sha256:$DIGEST"
        
        echo "digest=$DIGEST" >> $GITHUB_OUTPUT
        echo "Found multi-arch digest: $DIGEST"
    
    - name: GitHub Attestation
      uses: actions/attest@a63cfcc7d1aab266ee064c58250cfc2c7d07bc31 # v2.2.1
      with:
        subject-name: ${{ inputs.image-name }}
        subject-digest: ${{ steps.get_digest.outputs.digest }}
        predicate-type: "https://slsa.dev/provenance/v1"
        predicate: |
          {
            "buildType": "https://github.com/actions/runner-images/",
            "builder": {
              "id": "https://github.com/${{ inputs.repository }}/actions/runs/${{ inputs.workflow-run-id }}"
            },
            "invocation": {
              "configSource": {
                "uri": "git+https://github.com/${{ inputs.repository }}@${{ inputs.workflow-ref }}",
                "digest": {
                  "sha1": "${{ inputs.workflow-sha }}"
                },
                "entryPoint": ".github/workflows/${{ inputs.workflow }}.yaml"
              },
              "environment": {
                "github_workflow": "${{ inputs.workflow }}",
                "github_run_id": "${{ inputs.workflow-run-id }}"
              }
            },
            "metadata": {
              "buildInvocationID": "${{ inputs.workflow-run-id }}",
              "completeness": {
                "environment": true,
                "materials": true
              }
            }
          }
        push-to-registry: ${{ inputs.push-to-registry }}