name: "Setup OSFMount"
if: runner.os == 'Windows'
description: |
  Installs OSFmount for Windows and creates a RAM disk on drive R:.
runs:
  using: "composite"
  steps:
    - name: Install OSFMount
      if: runner.os == 'Windows'
      shell: bash
      run: |
        set -euo pipefail
        curl \
          --progress-bar \
          --show-error \
          --fail \
          --location \
          --output ./osfmount.exe \
          "$OSFMOUNT_URL"

        download_hash=$(sha256sum ./osfmount.exe | awk '{ print $1 }')
        if [ "$download_hash" != "$OSFMOUNT_SHA256" ]; then
          echo "Failed to verify osfmount.exe"
          echo "Expected: $OSFMOUNT_SHA256"
          echo "Got: $download_hash"
          exit 1
        fi

        ./osfmount.exe //silent //norestart
        # Close the GUI (which gets autolaunched and can't be disabled) and
        # delete the installer.
        taskkill //IM "OSFMount.exe" //F
        rm -f osfmount.exe
      env:
        OSFMOUNT_URL: https://storage.googleapis.com/coder-osfmount-binaries/osfmount-v3.1.1003.exe
        OSFMOUNT_SHA256: 9fe0738b7c2d29a7414e67f53aea359f3801d1c37b44f1b4fed5d02cb7536369

    - name: Create RAM Disk
      shell: bash
      run: |
        set -euo pipefail
        "/c/Program Files/OSFmount/OSFMount.com" -a -t vm -s 4096M -m R: -o hd,format:NTFS
