# docker-compose.dev.yml â€” Development environment
services:
  database:
    image: postgres:17
    environment:
      POSTGRES_USER: coder
      POSTGRES_PASSWORD: coder
      POSTGRES_DB: coder
    ports:
      - "5432:5432"
    volumes:
      - coder_dev_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U coder"]
      interval: 2s
      timeout: 5s
      retries: 10

  build-slim:
    image: golang:1.24
    working_dir: /app
    environment:
      GOMODCACHE: /go-cache/mod
      GOCACHE: /go-cache/build
    volumes:
      - .:/app
      - go_cache:/go-cache
      - coder_cache:/cache
    command: >
      sh -c '
        make build-slim &&
        mkdir -p /cache/site/orig/bin &&
        cp build/coder-slim_*_*_* /cache/site/orig/bin/ &&
        echo "Slim binaries built and cached."
      '

  coderd:
    image: golang:1.24
    depends_on:
      database:
        condition: service_healthy
      build-slim:
        condition: service_completed_successfully
    environment:
      CODER_PG_CONNECTION_URL: "postgresql://coder:coder@database:5432/coder?sslmode=disable"
      CODER_HTTP_ADDRESS: "0.0.0.0:3000"
      CODER_ACCESS_URL: "http://localhost:3000"
      CODER_SWAGGER_ENABLE: "true"
      CODER_DANGEROUS_ALLOW_CORS_REQUESTS: "true"
      CODER_TELEMETRY_ENABLE: "false"
      GOMODCACHE: /go-cache/mod
      GOCACHE: /go-cache/build
      CODER_CACHE_DIRECTORY: /cache
      DOCKER_HOST: "${DOCKER_HOST:-unix:///var/run/docker.sock}"
    # Add the Docker group so coderd can access the Docker socket.
    # Override DOCKER_GROUP if your host's docker group is not 999.
    group_add:
      - "${DOCKER_GROUP:-999}"
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3000/healthz || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 120s
    working_dir: /app
    volumes:
      - .:/app
      - go_cache:/go-cache
      - coder_cache:/cache
      - coderv2_config:/root/.config/coderv2
      - "${DOCKER_SOCKET:-/var/run/docker.sock}:/var/run/docker.sock"
    command: >
      go run ./enterprise/cmd/coder server
        --http-address 0.0.0.0:3000
        --access-url http://localhost:3000
        --swagger-enable
        --dangerous-allow-cors-requests=true
        --enable-terraform-debug-mode

  setup:
    build:
      context: .
      dockerfile: docker-compose/setup.Dockerfile
    depends_on:
      coderd:
        condition: service_healthy
    working_dir: /app
    environment:
      CODER_URL: "http://coderd:3000"
      DOCKER_HOST: "${DOCKER_HOST:-unix:///var/run/docker.sock}"
      GOMODCACHE: /go-cache/mod
      GOCACHE: /go-cache/build
    volumes:
      - .:/app
      - go_cache:/go-cache
      - coderv2_config:/root/.config/coderv2
      - ./scripts/docker-dev:/scripts:ro
    command: ["sh", "/scripts/setup.sh"]

  site:
    image: node:22
    depends_on:
      setup:
        condition: service_completed_successfully
    working_dir: /app/site
    environment:
      CODER_HOST: "http://coderd:3000"
    ports:
      - "8080:8080"
    volumes:
      - ./site:/app/site
      - site_node_modules:/app/site/node_modules
    command: sh -c "corepack enable && pnpm install --frozen-lockfile && pnpm dev --host"

volumes:
  coder_dev_data:
  coderv2_config:
  go_cache:
  coder_cache:
  site_node_modules:
