#!/sbin/openrc-run
name=coder
description="Coder - Self-hosted developer workspaces on your infra"
document="https://coder.com/docs/coder-oss"

depend() {
    need net
    after net-online
    use dns logger
}

checkpath --directory --owner coder:coder --mode 0700 /var/cache/coder

start_pre() {
    if [ ! -f /etc/coder.d/coder.env ]; then
        eerror "/etc/coder.d/coder.env file does not exist"
        return 1
    fi
    # Read and export environment variables ignoring comment lines and blank lines
    while IFS= read -r line; do
        # Skip blank or comment lines
        if [ -z "$line" ] || [[ "$line" =~ ^# ]]; then
            continue
        fi
        export "$line"
    done < /etc/coder.d/coder.env
}

command="/usr/bin/coder"
command_args="server"
command_user="coder:coder"
command_background="yes"
pidfile="/run/coder.pid"

restart="always"
restart_delay="5"

stop_timeout="90"
