<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>cdev - Development Environment</title>
  <style>
    :root {
      --bg: #1a1a2e;
      --card-bg: #16213e;
      --accent: #0f3460;
      --primary: #e94560;
      --text: #eaeaea;
      --text-muted: #a0a0a0;
      --success: #4ade80;
      --warning: #fbbf24;
      --error: #f87171;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 2rem;
    }
    .container { max-width: 900px; margin: 0 auto; }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    h1 { font-size: 1.5rem; display: flex; align-items: center; gap: 0.5rem; }
    .status-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .refresh-info { color: var(--text-muted); font-size: 0.875rem; }
    .services { display: flex; flex-direction: column; gap: 1rem; }
    .service {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1rem 1.25rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: transform 0.1s, box-shadow 0.1s;
    }
    .service:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .service-emoji { font-size: 1.5rem; }
    .service-info { flex: 1; }
    .service-name { font-weight: 600; font-size: 1.1rem; }
    .service-deps { color: var(--text-muted); font-size: 0.8rem; margin-top: 0.25rem; }
    .service-step { color: var(--primary); font-size: 0.8rem; margin-top: 0.25rem; font-style: italic; }
    .service-unmet { color: var(--warning); font-size: 0.8rem; margin-top: 0.25rem; }
    .service-status {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
    }
    .status-completed { background: rgba(74, 222, 128, 0.2); color: var(--success); }
    .status-started { background: rgba(251, 191, 36, 0.2); color: var(--warning); }
    .status-pending { background: rgba(160, 160, 160, 0.2); color: var(--text-muted); }
    .status-not-registered { background: rgba(248, 113, 113, 0.2); color: var(--error); }
    .service-actions { display: flex; gap: 0.5rem; }
    button {
      background: var(--accent);
      border: none;
      color: var(--text);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background 0.2s;
    }
    button:hover { background: var(--primary); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .error {
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid var(--error);
      color: var(--error);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><span class="status-dot"></span> cdev</h1>
      <span class="refresh-info">Auto-refresh: 2s</span>
    </header>
    <div id="error" class="error" style="display: none;"></div>
    <div id="services" class="services">
      <div class="loading">Loading services...</div>
    </div>
  </div>

  <script>
    const API_BASE = '';
    let services = [];

    async function fetchServices() {
      try {
        const res = await fetch(`${API_BASE}/api/services`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        services = data.services || [];
        hideError();
        render();
      } catch (err) {
        showError(`Failed to fetch services: ${err.message}`);
      }
    }

    async function restartService(name) {
      setLoading(name, true);
      try {
        const res = await fetch(`${API_BASE}/api/services/${name}/restart`, { method: 'POST' });
        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || `HTTP ${res.status}`);
        }
        await fetchServices();
      } catch (err) {
        showError(`Failed to restart ${name}: ${err.message}`);
      } finally {
        setLoading(name, false);
      }
    }

    async function stopService(name) {
      setLoading(name, true);
      try {
        const res = await fetch(`${API_BASE}/api/services/${name}/stop`, { method: 'POST' });
        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || `HTTP ${res.status}`);
        }
        await fetchServices();
      } catch (err) {
        showError(`Failed to stop ${name}: ${err.message}`);
      } finally {
        setLoading(name, false);
      }
    }

    function setLoading(name, loading) {
      const btns = document.querySelectorAll(`[data-service="${name}"] button`);
      btns.forEach(btn => btn.disabled = loading);
    }

    function showError(msg) {
      const el = document.getElementById('error');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function hideError() {
      document.getElementById('error').style.display = 'none';
    }

    function render() {
      const container = document.getElementById('services');
      if (services.length === 0) {
        container.innerHTML = '<div class="loading">No services found</div>';
        return;
      }

      const sorted = [...services].sort((a, b) => a.name.localeCompare(b.name));
      container.innerHTML = sorted.map(svc => {
        // Handle empty status (not registered) and format for CSS class.
        const status = svc.status || 'not-registered';
        const statusClass = 'status-' + status.replace('_', '-');
        const statusLabel = status === 'not-registered' ? 'not registered' : status;
        const stepHtml = svc.current_step
          ? `<div class="service-step">▶ ${svc.current_step}</div>`
          : '';
        const unmetHtml = svc.unmet_dependencies?.length
          ? `<div class="service-unmet">⏳ waiting for: ${svc.unmet_dependencies.join(', ')}</div>`
          : '';
        return `
          <div class="service" data-service="${svc.name}">
            <span class="service-emoji">${svc.emoji}</span>
            <div class="service-info">
              <div class="service-name">${svc.name}</div>
              <div class="service-deps">${svc.depends_on?.length ? `depends on: ${svc.depends_on.join(', ')}` : 'no dependencies'}</div>
              ${stepHtml}
              ${unmetHtml}
            </div>
            <span class="service-status ${statusClass}">${statusLabel}</span>
            <div class="service-actions">
              <button onclick="restartService('${svc.name}')">Restart</button>
              <button onclick="stopService('${svc.name}')">Stop</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Initial fetch and auto-refresh.
    fetchServices();
    setInterval(fetchServices, 2000);
  </script>
</body>
</html>
