{{- define "libcoder.rbac.forNamespace" -}}
{{- $top := .Top -}}
{{- $ns := .NS -}}
{{- $nsPerms := ternary .workspacePerms $top.Values.coder.serviceAccount.workspacePerms (hasKey . "workspacePerms") -}}
{{- $nsDeploy := ternary .enableDeployments $top.Values.coder.serviceAccount.enableDeployments (hasKey . "enableDeployments") -}}
{{- $nsExtra  := ternary .extraRules $top.Values.coder.serviceAccount.extraRules (hasKey . "extraRules") -}}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ $top.Values.coder.serviceAccount.name }}-workspace-perms
  namespace: {{ $ns }}
rules:
  {{- if $nsPerms }}
{{ include "libcoder.rbac.rules.basic" $top | indent 2 }}
    {{- if $nsDeploy }}
{{ include "libcoder.rbac.rules.deployments" $top | indent 2 }}
    {{- end }}

  {{- with $nsExtra }}
{{ toYaml . | nindent 2 }}
  {{- end }}
  {{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ $top.Values.coder.serviceAccount.name | quote }}
  namespace: {{ $ns }}
subjects:
  - kind: ServiceAccount
    name: {{ $top.Values.coder.serviceAccount.name | quote }}
    {{- if ne $ns $top.Release.Namespace }}
    namespace: {{ $top.Release.Namespace }}
    {{- end }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ $top.Values.coder.serviceAccount.name }}-workspace-perms
{{ end }}

{{- define "libcoder.rbac.tpl" -}}
{{- if .Values.coder.serviceAccount.workspacePerms }}
{{ include "libcoder.rbac.forNamespace" (dict "Top" . "NS" .Release.Namespace) }}
{{ end }}

{{- with .Values.coder.serviceAccount.workspaceNamespaces.namespaces }}
{{- range . }}
{{- if .name }}
{{ include "libcoder.rbac.forNamespace" (dict "Top" $ "NS" .name "workspacePerms" .workspacePerms "enableDeployments" .enableDeployments "extraRules" .extraRules) }}
{{ end }}
{{- end }}
{{- end }}
{{- end -}}
