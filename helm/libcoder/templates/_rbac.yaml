{{- define "libcoder.rbac.forNamespace" -}}
{{- $top := .Top -}}
{{- $ns := .NS -}}
{{- $nsPerms := ternary .workspacePerms $top.Values.coder.serviceAccount.workspacePerms (hasKey . "workspacePerms") -}}
{{- $nsDeploy := ternary .enableDeployments $top.Values.coder.serviceAccount.enableDeployments (hasKey . "enableDeployments") -}}
{{- $nsExtra  := ternary .extraRules $top.Values.coder.serviceAccount.extraRules (hasKey . "extraRules") -}}
{{- if $nsPerms }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ $top.Values.coder.serviceAccount.name }}-workspace-perms
  namespace: {{ $ns }}
rules:
{{ include "libcoder.rbac.rules.basic" $top | indent 2 }}
{{- if $nsDeploy }}
{{ include "libcoder.rbac.rules.deployments" $top | indent 2 }}
{{- end }}
{{- with $nsExtra }}
{{ toYaml . | nindent 2 }}
{{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ $top.Values.coder.serviceAccount.name | quote }}
  namespace: {{ $ns }}
subjects:
  - kind: ServiceAccount
    name: {{ $top.Values.coder.serviceAccount.name | quote }}
    {{- if ne $ns $top.Release.Namespace }}
    namespace: {{ $top.Release.Namespace }}
    {{- end }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ $top.Values.coder.serviceAccount.name }}-workspace-perms
{{- end }}
{{- end }}

{{- define "libcoder.rbac.tpl" -}}
{{- $coder := .Values.coder | default dict -}}
{{- $sa := $coder.serviceAccount | default dict -}}
{{- $ws := $sa.workspaceNamespaces | default dict -}}
{{- $extra := $ws.namespaces | default (list) -}}
{{- $targets := concat (list (dict "name" .Release.Namespace)) $extra -}}

{{- range $i, $ns := $targets }}
{{- if $ns.name }}
{{- $params := dict "Top" $ "NS" $ns.name -}}
{{- if hasKey $ns "workspacePerms" }}{{- $_ := set $params "workspacePerms" $ns.workspacePerms }}{{- end }}
{{- if hasKey $ns "enableDeployments" }}{{- $_ := set $params "enableDeployments" $ns.enableDeployments }}{{- end }}
{{- if hasKey $ns "extraRules" }}{{- $_ := set $params "extraRules" $ns.extraRules }}{{- end }}
{{ include "libcoder.rbac.forNamespace" $params }}
{{- end }}
{{- end }}
{{- end -}}
