{{- define "libcoder.rbac.forNamespace" -}}
{{- $top := .Top -}}
{{- $ns := .NS -}}
{{- $nsPerms := ternary .workspacePerms $top.Values.coder.serviceAccount.workspacePerms (hasKey . "workspacePerms") -}}
{{- $nsDeploy := ternary .enableDeployments $top.Values.coder.serviceAccount.enableDeployments (hasKey . "enableDeployments") -}}
{{- $nsExtra := ternary .extraRules $top.Values.coder.serviceAccount.extraRules (hasKey . "extraRules") -}}
{{- if or $nsPerms (or $nsDeploy $nsExtra) }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ $top.Values.coder.serviceAccount.name }}-workspace-perms
  namespace: {{ $ns }}
rules:
{{- if $nsPerms }}
{{ include "libcoder.rbac.rules.basic" $top | trimPrefix "\n" | indent 2 }}
{{- end }}
{{- if $nsDeploy }}
{{ include "libcoder.rbac.rules.deployments" $top | trimPrefix "\n" | indent 2 }}
{{- end }}
{{- with $nsExtra }}
  {{- if kindIs "slice" . }}
{{ toYaml . | trimPrefix "\n" | indent 2 }}
  {{- else }}
{{ toYaml (list .) | trimPrefix "\n" | indent 2 }}
  {{- end }}
{{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ $top.Values.coder.serviceAccount.name | quote }}
  namespace: {{ $ns }}
subjects:
  - kind: ServiceAccount
    name: {{ $top.Values.coder.serviceAccount.name | quote }}
    {{- if ne $ns $top.Release.Namespace }}
    namespace: {{ $top.Release.Namespace }}
    {{- end }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ $top.Values.coder.serviceAccount.name }}-workspace-perms
  {{- end }}
{{- end -}}

{{- define "libcoder.rbac.tpl" -}}
  {{- $top := . -}}
  {{- $rootPerms := $top.Values.coder.serviceAccount.workspacePerms | default false -}}
  {{- $rootDeploy := $top.Values.coder.serviceAccount.enableDeployments | default false -}}
  {{- $rootExtra  := $top.Values.coder.serviceAccount.extraRules | default (list) -}}

  {{- $rootParams := dict
        "Top" $top
        "NS"  $top.Release.Namespace
        "workspacePerms" $rootPerms
        "enableDeployments" $rootDeploy
        "extraRules" $rootExtra -}}
  {{ include "libcoder.rbac.forNamespace" $rootParams }}

  {{- $extra := ($top.Values.coder.serviceAccount.workspaceNamespaces.namespaces | default (list)) -}}
  {{- range $_, $ns := $extra }}
    {{- if $ns.name }}
      {{- $params := dict "Top" $top "NS" $ns.name -}}
      {{- if hasKey $ns "workspacePerms" }}{{- $_ := set $params "workspacePerms" $ns.workspacePerms }}{{- else }}{{- $_ := set $params "workspacePerms" $rootPerms }}{{- end }}
      {{- if hasKey $ns "enableDeployments" }}{{- $_ := set $params "enableDeployments" $ns.enableDeployments }}{{- else }}{{- $_ := set $params "enableDeployments" $rootDeploy }}{{- end }}
      {{- if hasKey $ns "extraRules" }}{{- $_ := set $params "extraRules" $ns.extraRules }}{{- else }}{{- $_ := set $params "extraRules" $rootExtra }}{{- end }}
      {{ include "libcoder.rbac.forNamespace" $params }}
    {{- end }}
  {{- end }}
{{- end -}}
